---
phase: 05-reporting-output
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - templates/report.hbs
  - templates/styles/report.css
  - src/reports/html-generator.ts
autonomous: true

must_haves:
  truths:
    - "HTML report is a single self-contained file with inline CSS and base64 screenshots"
    - "HTML report opens in any browser without internet, CDN, or external dependencies"
    - "HTML report shows health score with color-coded label (green/yellow/red)"
    - "HTML report displays prioritized to-do list with what to fix first"
    - "HTML report embeds screenshots for issues that have them"
    - "HTML report uses plain English with zero jargon"
  artifacts:
    - path: "templates/report.hbs"
      provides: "Main Handlebars HTML template with inline CSS"
      min_lines: 100
    - path: "templates/styles/report.css"
      provides: "CSS styles for report (also inlined into template at build time)"
      min_lines: 50
    - path: "src/reports/html-generator.ts"
      provides: "generateHtmlReport function producing self-contained HTML string"
      exports: ["generateHtmlReport"]
  key_links:
    - from: "src/reports/html-generator.ts"
      to: "src/reports/health-scorer.ts"
      via: "calculateHealthScore import"
      pattern: "import.*calculateHealthScore"
    - from: "src/reports/html-generator.ts"
      to: "src/reports/priority-ranker.ts"
      via: "prioritizeIssues import"
      pattern: "import.*prioritizeIssues"
    - from: "src/reports/html-generator.ts"
      to: "templates/report.hbs"
      via: "fs.readFileSync template loading"
      pattern: "readFile.*report\\.hbs"
---

<objective>
Create the standalone HTML report generator with Handlebars templates, inline CSS, and base64-embedded screenshots. The report must open in any browser without external dependencies.

Purpose: Satisfies RPRT-01 (HTML report), RPRT-02 (plain English), RPRT-03 (embedded screenshots), RPRT-04 (prioritized to-do list), RPRT-05 (health score).
Output: Handlebars template + CSS + html-generator.ts producing self-contained HTML.
</objective>

<execution_context>
@C:\Users\Shiv_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shiv_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-output/05-RESEARCH.md
@.planning/phases/05-reporting-output/05-01-PLAN.md
@src/types/execution.ts
@src/types/artifacts.ts
@src/analysis/diagnosis-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Handlebars template with inline CSS</name>
  <files>templates/report.hbs, templates/styles/report.css</files>
  <action>
    1. Create `templates/styles/report.css` with a clean, modern design:
       - System font stack: `system-ui, -apple-system, 'Segoe UI', sans-serif`
       - Color palette: white background (#ffffff), light gray sections (#f8fafc), dark text (#1e293b)
       - Priority colors: high = red (#ef4444), medium = amber (#f59e0b), low = indigo (#6366f1)
       - Health score colors: good = emerald (#10b981), needs-work = amber (#f59e0b), poor = red (#ef4444)
       - Responsive layout: max-width 1200px, centered, mobile-friendly
       - Issue cards: left border colored by priority, subtle background, rounded corners
       - Screenshot images: max-width 100%, border, rounded corners, margin-top
       - Score display: large bold number (64px), label underneath
       - Score breakdown: horizontal bar or simple grid showing 4 dimension scores
       - To-do list section: numbered items with priority badges
       - Workflow results section: pass/fail indicators
       - Footer: "Generated by Afterburn" with timestamp
       - Print-friendly: hide non-essential elements on print

    2. Create `templates/report.hbs`:
       - Full HTML5 document with `<!DOCTYPE html>`, lang="en", charset UTF-8, viewport meta
       - `<title>Afterburn Report - {{targetUrl}}</title>`
       - `<style>{{{inlineCSS}}}</style>` (triple braces for raw CSS, no escaping)
       - Body structure:
         - **Header:** Afterburn logo text + "Test Report" + target URL + scan date
         - **Health Score Section:**
           - Large score number: `{{healthScore.overall}}/100`
           - Label badge: `{{healthScore.label}}` with color class `health-{{healthScore.label}}`
           - Breakdown grid: Workflows {{healthScore.breakdown.workflows}}%, Errors {{healthScore.breakdown.errors}}%, Accessibility {{healthScore.breakdown.accessibility}}%, Performance {{healthScore.breakdown.performance}}%
           - Checks passed: `{{healthScore.checksPassed}} of {{healthScore.checksTotal}} checks passed`
         - **What to Fix First (To-Do List):**
           - `{{#each prioritizedIssues}}` block
           - Each item: priority badge, summary, impact ("Why it matters"), fix suggestion ("How to fix")
           - If `screenshotDataUri` exists: `<img src="{{screenshotDataUri}}" alt="Screenshot showing the issue" />`
           - Number each item starting from 1
         - **Workflow Results:**
           - `{{#each workflowResults}}` block
           - Each: workflow name, pass/fail badge, step count, duration
           - Expandable step details (use `<details><summary>` HTML element for no-JS expand)
         - **Accessibility Summary:**
           - Total violations count
           - Critical/serious/moderate/minor breakdown
         - **Performance Summary:**
           - Average LCP, load time per page
         - **Footer:**
           - "Generated by Afterburn" + timestamp
           - AI-powered badge if applicable
       - Use Handlebars helpers:
         - `{{#if}}` for conditional sections (screenshots, source analysis)
         - `{{#each}}` for iteration
         - No custom helpers needed -- keep it simple with triple-brace `{{{raw}}}` for HTML content
  </action>
  <verify>
    Verify template files exist at expected paths. Verify template uses `{{{inlineCSS}}}` (triple braces) for raw CSS injection. Verify no external CDN links in template.
  </verify>
  <done>
    report.hbs is a complete HTML5 document with inline CSS slot, health score display, prioritized to-do list, workflow results, and screenshot embedding. report.css has modern, clean styling with priority-based colors. No external dependencies (no CDN links, no external stylesheets, no external scripts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML report generator</name>
  <files>src/reports/html-generator.ts</files>
  <action>
    Create `src/reports/html-generator.ts`:

    1. Imports:
       - `import Handlebars from 'handlebars'`
       - `import fs from 'fs-extra'`
       - `import sharp from 'sharp'`
       - `import { join, dirname } from 'node:path'`
       - `import { fileURLToPath } from 'node:url'`
       - `import { calculateHealthScore } from './health-scorer.js'`
       - `import { prioritizeIssues } from './priority-ranker.js'`
       - `import type { ExecutionArtifact } from '../types/execution.js'`
       - `import type { AnalysisArtifact } from '../analysis/diagnosis-schema.js'`

    2. Helper function `async function loadScreenshotAsBase64(screenshotRef: string | undefined): Promise<string | undefined>`:
       - If screenshotRef is undefined, return undefined
       - Try to read the WebP file (check for webpPath pattern) or PNG file
       - Use sharp to resize to max 768px width (research recommends this to avoid base64 bloat)
       - Convert to WebP buffer with quality 80
       - If resulting buffer > 100KB, reduce quality to 60 and try again
       - Return `data:image/webp;base64,${buffer.toString('base64')}`
       - On any error, return undefined (graceful degradation)

    3. Export `async function generateHtmlReport(executionArtifact: ExecutionArtifact, analysisArtifact: AnalysisArtifact): Promise<string>`:
       - Calculate health score: `const healthScore = calculateHealthScore(executionArtifact)`
       - Prioritize issues: `const prioritizedIssues = prioritizeIssues(analysisArtifact.diagnosedErrors, analysisArtifact.uiAudits, executionArtifact)`
       - Load screenshots for each prioritized issue that has a screenshotRef:
         ```typescript
         const issuesWithScreenshots = await Promise.all(
           prioritizedIssues.map(async (issue) => ({
             ...issue,
             screenshotDataUri: await loadScreenshotAsBase64(issue.screenshotRef),
           }))
         );
         ```
       - Load CSS from templates/styles/report.css using `fileURLToPath(import.meta.url)` to resolve path relative to compiled JS output. Use `join(dirname(fileURLToPath(import.meta.url)), '../../templates/styles/report.css')`. Read as string.
       - Load template from templates/report.hbs similarly.
       - Compile template: `const template = Handlebars.compile(templateSource)`
       - Render with data:
         ```typescript
         const html = template({
           targetUrl: executionArtifact.targetUrl,
           scanDate: new Date(executionArtifact.timestamp).toLocaleString(),
           healthScore,
           prioritizedIssues: issuesWithScreenshots,
           workflowResults: executionArtifact.workflowResults,
           pageAudits: executionArtifact.pageAudits,
           totalIssues: executionArtifact.totalIssues,
           aiPowered: analysisArtifact.aiPowered,
           sourceAnalysisAvailable: analysisArtifact.sourceAnalysisAvailable,
           inlineCSS: cssContent,
         });
         ```
       - Return the HTML string

    4. Export `async function writeHtmlReport(html: string, outputPath: string): Promise<void>`:
       - Ensure parent directory exists with `fs.ensureDir(dirname(outputPath))`
       - Write HTML string to outputPath
       - Log: `console.log('HTML report saved: ' + outputPath)`

    **Important:** Use `fileURLToPath(import.meta.url)` for ESM-compatible path resolution. The compiled JS will be in `dist/reports/html-generator.js`, and templates are at the project root in `templates/`. The relative path from dist/reports/ to templates/ is `../../templates/`.

    **Important:** Template path resolution must work both when running from `dist/` (compiled) and from `src/` (via tsx). Use an explicit fallback pattern:
       ```typescript
       const __filename = fileURLToPath(import.meta.url);
       const __dirname = dirname(__filename);

       function resolveTemplatePath(relativePath: string): string {
         // From dist/reports/ -> ../../templates/ (compiled)
         const distPath = join(__dirname, '../../templates', relativePath);
         if (fs.existsSync(distPath)) return distPath;
         // From src/reports/ -> ../templates/ (tsx/dev)
         const srcPath = join(__dirname, '../templates', relativePath);
         if (fs.existsSync(srcPath)) return srcPath;
         throw new Error(`Template not found: ${relativePath} (tried ${distPath} and ${srcPath})`);
       }
       ```
       Use `resolveTemplatePath('report.hbs')` and `resolveTemplatePath('styles/report.css')` when loading templates.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Verify the file exports `generateHtmlReport` and `writeHtmlReport`.
  </verify>
  <done>
    html-generator.ts exports generateHtmlReport (returns self-contained HTML string) and writeHtmlReport (saves to file). Screenshots are base64-embedded at max 768px width. CSS is inlined. Template is loaded from templates/report.hbs. All paths use ESM-compatible resolution.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. templates/report.hbs exists with full HTML5 structure
3. templates/styles/report.css exists with modern styling
4. src/reports/html-generator.ts exports generateHtmlReport and writeHtmlReport
5. No CDN links or external dependencies in template
6. CSS is inlined via triple-brace Handlebars syntax
7. Screenshots are base64-embedded with size limits
</verification>

<success_criteria>
- HTML report is a single self-contained file (no external deps) [RPRT-01]
- Report uses plain English everywhere [RPRT-02]
- Screenshots embedded as base64 data URIs [RPRT-03]
- Prioritized to-do list shows what to fix first [RPRT-04]
- Health score displayed with color-coded label [RPRT-05]
- Template compiles with Handlebars without errors
- CSS is clean, modern, responsive design
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-output/05-02-SUMMARY.md`
</output>
