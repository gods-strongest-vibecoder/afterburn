---
phase: 05-reporting-output
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/reports/markdown-generator.ts
autonomous: true

must_haves:
  truths:
    - "Markdown report has YAML frontmatter with machine-readable metadata (session_id, health_score, total_issues)"
    - "Markdown report includes technical error details with original error messages"
    - "Markdown report includes reproduction steps from failed workflow step results"
    - "Markdown report references source code files and line numbers when source analysis is available"
    - "Markdown report uses consistent heading hierarchy for AI parsing (H1 title, H2 sections, H3 subsections)"
    - "Markdown report includes prioritized issue table with columns for priority, summary, location, fix"
  artifacts:
    - path: "src/reports/markdown-generator.ts"
      provides: "generateMarkdownReport function returning structured Markdown string with YAML frontmatter"
      exports: ["generateMarkdownReport", "writeMarkdownReport"]
  key_links:
    - from: "src/reports/markdown-generator.ts"
      to: "src/reports/health-scorer.ts"
      via: "calculateHealthScore import"
      pattern: "import.*calculateHealthScore"
    - from: "src/reports/markdown-generator.ts"
      to: "src/reports/priority-ranker.ts"
      via: "prioritizeIssues import"
      pattern: "import.*prioritizeIssues"
---

<objective>
Create the structured Markdown report generator for AI coding tool consumption (Claude, Cursor, Copilot). The report uses YAML frontmatter, consistent heading hierarchy, tables, and code blocks for machine-readable structure.

Purpose: Satisfies RPRT-06 (Markdown AI report), RPRT-07 (technical details/reproduction steps), RPRT-08 (source code references).
Output: markdown-generator.ts producing structured Markdown optimized for LLM parsing.
</objective>

<execution_context>
@C:\Users\Shiv_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shiv_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-output/05-RESEARCH.md
@.planning/phases/05-reporting-output/05-01-PLAN.md
@src/types/execution.ts
@src/types/artifacts.ts
@src/analysis/diagnosis-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Markdown report generator</name>
  <files>src/reports/markdown-generator.ts</files>
  <action>
    Create `src/reports/markdown-generator.ts`:

    1. Imports:
       - `import fs from 'fs-extra'`
       - `import { dirname } from 'node:path'`
       - `import { calculateHealthScore } from './health-scorer.js'`
       - `import { prioritizeIssues } from './priority-ranker.js'`
       - `import type { HealthScore } from './health-scorer.js'`
       - `import type { PrioritizedIssue } from './priority-ranker.js'`
       - `import type { ExecutionArtifact, WorkflowExecutionResult } from '../types/execution.js'`
       - `import type { AnalysisArtifact, DiagnosedError, UIAuditResult } from '../analysis/diagnosis-schema.js'`

    2. Internal helper `function generateFrontmatter(exec: ExecutionArtifact, analysis: AnalysisArtifact, healthScore: HealthScore): string`:
       - Return YAML frontmatter block with:
         ```
         ---
         tool: afterburn
         version: "1.0"
         session_id: {sessionId}
         timestamp: {timestamp}
         target_url: {targetUrl}
         health_score: {overall}
         health_label: {label}
         total_issues: {totalIssues}
         workflows_tested: {workflowResults.length}
         workflows_passed: {count of passed}
         workflows_failed: {count of failed}
         ai_powered: {boolean}
         source_analysis: {boolean}
         ---
         ```

    3. Internal helper `function generateIssueTable(issues: PrioritizedIssue[]): string`:
       - Return a Markdown table with columns: #, Priority, Category, Summary, Location
       - Each row: issue number, priority in CAPS, category, summary (truncated to 80 chars), location
       - If no issues: return "No issues found."

    4. Internal helper `function generateTechnicalDetails(diagnosedErrors: DiagnosedError[]): string`:
       - For each diagnosed error, generate a subsection (H3):
         ```
         ### {i+1}. {summary}

         - **Error Type:** {errorType}
         - **Confidence:** {confidence}
         - **Root Cause:** {rootCause}
         - **Suggested Fix:** {suggestedFix}
         - **Original Error:** `{originalError}`
         {if technicalDetails:}
         - **Technical Details:** {technicalDetails}
         {if sourceLocation:}
         - **Source:** `{file}:{line}`
         - **Code Context:**
         ```typescript
         {sourceLocation.context}
         ```
         ```
       - If no errors: return "No errors diagnosed."

    5. Internal helper `function generateReproductionSteps(workflowResults: WorkflowExecutionResult[]): string`:
       - Filter to failed workflows only
       - For each failed workflow:
         ```
         ### {workflowName}

         **Description:** {description}
         **Status:** Failed ({failedSteps}/{totalSteps} steps failed)
         **Duration:** {duration}ms

         **Steps:**
         1. {action} on `{selector}` - {status}
            {if error:} Error: {error}
         2. ...
         ```
       - Include ALL steps (passed and failed) so AI can see the full flow
       - If no failed workflows: return "All workflows passed successfully."

    6. Internal helper `function generateUIAuditSection(uiAudits: UIAuditResult[]): string`:
       - For each UI audit result:
         ```
         ### {pageUrl}

         **Overall Score:** {overallScore}

         **Layout Issues:**
         {for each issue:}
         - [{severity}] {description} at {location}

         **Contrast Issues:**
         {for each issue:}
         - {element}: {issue} - Fix: {suggestion}

         **Formatting Issues:**
         {for each issue:}
         - {problem} - Fix: {suggestion}

         **Improvements:**
         {for each:}
         - {improvement}
         ```
       - If no UI audits: return "No UI audits performed."

    7. Internal helper `function generateSourceReferences(diagnosedErrors: DiagnosedError[]): string`:
       - Filter to errors with sourceLocation defined
       - For each:
         ```
         - `{file}:{line}` - {summary}
         ```
       - If none: return "No source code references available. Run with `--source ./path` for source-level diagnosis."

    8. Internal helper `function generateAccessibilitySummary(executionArtifact: ExecutionArtifact): string`:
       - Aggregate all accessibility violations across pageAudits
       - Table: | Page | Critical | Serious | Moderate | Minor | Total |
       - List top violations with help URLs

    9. Export `function generateMarkdownReport(executionArtifact: ExecutionArtifact, analysisArtifact: AnalysisArtifact): string`:
       - Calculate health score and prioritize issues
       - Build the full Markdown document:
         ```
         {frontmatter}

         # Afterburn Test Report

         **Target:** {targetUrl}
         **Health Score:** {overall}/100 ({label})
         **Date:** {timestamp as readable string}
         **Mode:** {AI-powered or Basic}

         ## Summary

         | Metric | Value |
         |--------|-------|
         | Workflows Tested | {N} |
         | Workflows Passed | {N} |
         | Workflows Failed | {N} |
         | Total Issues | {N} |
         | Dead Buttons | {N} |
         | Broken Forms | {N} |
         | Accessibility Violations | {N} |

         ## Issues (Prioritized)

         {issueTable}

         ## Issue Details

         {technicalDetails for each issue}

         ## Reproduction Steps

         {reproductionSteps}

         ## UI Audit Results

         {uiAuditSection}

         ## Accessibility

         {accessibilitySummary}

         ## Source Code References

         {sourceReferences}

         ---

         *Generated by Afterburn v1.0 on {timestamp}*
         ```
       - Return the complete Markdown string

    10. Export `async function writeMarkdownReport(markdown: string, outputPath: string): Promise<void>`:
        - Ensure parent directory exists with `fs.ensureDir(dirname(outputPath))`
        - Write Markdown string to outputPath
        - Log: `console.log('Markdown report saved: ' + outputPath)`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Verify the file exports `generateMarkdownReport` and `writeMarkdownReport`.
  </verify>
  <done>
    markdown-generator.ts exports generateMarkdownReport (returns Markdown string with YAML frontmatter) and writeMarkdownReport (saves to file). Report includes all required sections: frontmatter metadata, prioritized issue table, technical error details, reproduction steps, UI audit results, accessibility summary, and source code references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Markdown structure is AI-parseable</name>
  <files>src/reports/markdown-generator.ts</files>
  <action>
    Review and validate the generated Markdown structure for AI consumption:

    1. Verify YAML frontmatter is properly delimited with `---` markers
    2. Verify heading hierarchy: H1 for title, H2 for sections, H3 for subsections (no skipped levels)
    3. Verify all tables have header rows with `|` delimiters
    4. Verify code blocks use triple backticks with language hints (```typescript, ```bash)
    5. Verify explicit labels for metadata: `**Priority:** HIGH` not emoji-only markers
    6. Verify source code references use backtick-quoted file paths: `src/file.ts:42`
    7. Verify no trailing whitespace issues or inconsistent line endings

    If any structural issues found, fix them in the generator code.

    Also verify edge cases:
    - Empty diagnosedErrors array produces "No errors diagnosed" message
    - Empty uiAudits array produces "No UI audits performed" message
    - No source analysis produces guidance message about --source flag
    - All workflows passing produces "All workflows passed" message
    - Zero workflows produces graceful handling (no division by zero)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types still compile after any fixes.
  </verify>
  <done>
    Markdown report structure verified: proper YAML frontmatter, consistent heading hierarchy, labeled tables, language-hinted code blocks, explicit priority labels, and graceful empty-state handling.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. src/reports/markdown-generator.ts exists with generateMarkdownReport and writeMarkdownReport exports
3. YAML frontmatter includes session_id, health_score, total_issues, ai_powered, source_analysis
4. Issue table has Priority, Category, Summary, Location columns
5. Technical details section includes original error messages
6. Reproduction steps section includes all workflow steps for failed workflows
7. Source code references section includes file:line when available
8. Edge cases handled gracefully (empty arrays, no workflows, no source)
</verification>

<success_criteria>
- Markdown report has YAML frontmatter with machine-readable metadata [RPRT-06]
- Report includes technical error details and original error messages [RPRT-07]
- Report includes reproduction steps from failed workflows [RPRT-07]
- Report references source code files and line numbers [RPRT-08]
- Consistent heading hierarchy (H1/H2/H3) for AI parsing
- Tables with header rows for structured data
- Code blocks with language hints
- All edge cases produce meaningful fallback messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-output/05-03-SUMMARY.md`
</output>
