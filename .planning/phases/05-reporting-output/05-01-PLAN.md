---
phase: 05-reporting-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/reports/health-scorer.ts
  - src/reports/priority-ranker.ts
autonomous: true

must_haves:
  truths:
    - "Health score calculates a 0-100 weighted score from workflow results, errors, accessibility, and performance"
    - "Health score applies veto logic: any critical workflow failure caps score at 50"
    - "Priority ranker categorizes issues as high/medium/low based on error type and severity"
    - "Priority ranker returns issues sorted by priority (high first)"
  artifacts:
    - path: "src/reports/health-scorer.ts"
      provides: "calculateHealthScore function returning HealthScore with overall, label, breakdown"
      exports: ["calculateHealthScore", "HealthScore"]
    - path: "src/reports/priority-ranker.ts"
      provides: "prioritizeIssues function returning PrioritizedIssue[] sorted by priority"
      exports: ["prioritizeIssues", "PrioritizedIssue", "IssuePriority"]
  key_links:
    - from: "src/reports/health-scorer.ts"
      to: "src/types/execution.ts"
      via: "ExecutionArtifact import"
      pattern: "import.*ExecutionArtifact"
    - from: "src/reports/priority-ranker.ts"
      to: "src/analysis/diagnosis-schema.ts"
      via: "DiagnosedError and UIAuditResult imports"
      pattern: "import.*DiagnosedError"
---

<objective>
Install report dependencies (Handlebars, marked) and create the health scoring and issue prioritization modules that both HTML and Markdown report generators will consume.

Purpose: Foundational logic needed before report generators can produce prioritized, scored output.
Output: health-scorer.ts and priority-ranker.ts modules with exported types and functions.
</objective>

<execution_context>
@C:\Users\Shiv_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shiv_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-output/05-RESEARCH.md
@src/types/execution.ts
@src/analysis/diagnosis-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create health scorer</name>
  <files>package.json, src/reports/health-scorer.ts</files>
  <action>
    1. Install Handlebars and marked:
       ```bash
       npm install handlebars marked
       npm install --save-dev @types/marked
       ```
       Note: Handlebars ships with its own types. Modern `marked` (v4+) ships with built-in TypeScript types, so `@types/marked` is NOT needed -- skip installing it. If the `npm install --save-dev @types/marked` command fails or warns, ignore it and continue.

    2. Create `src/reports/health-scorer.ts` with:
       - Import `ExecutionArtifact` from `../types/execution.js`
       - Export `HealthScore` interface:
         ```typescript
         export interface HealthScore {
           overall: number;        // 0-100
           label: 'good' | 'needs-work' | 'poor';
           breakdown: {
             workflows: number;    // 0-100
             errors: number;       // 0-100
             accessibility: number; // 0-100
             performance: number;  // 0-100
           };
           checksPassed: number;
           checksTotal: number;
         }
         ```
       - Export `calculateHealthScore(executionArtifact: ExecutionArtifact): HealthScore` function:
         - **Workflow score (40% weight):** `(passedWorkflows / totalWorkflows) * 100`. If no workflows, default to 100.
         - **Error score (30% weight):** `Math.max(0, 100 - (totalIssues * 2))`. Each issue deducts 2 points.
         - **Accessibility score (20% weight):** `Math.max(0, 100 - (criticalViolations * 10) - (seriousViolations * 5))`. Critical = -10, serious = -5.
         - **Performance score (10% weight):** Average LCP across pageAudits. LCP < 2500ms = 100, 2500-4000ms = 75, > 4000ms = 50. If no perf data, default to 100.
         - **Veto logic:** If ANY workflow has `overallStatus === 'failed'`, cap `overall` at maximum 50.
         - **Label mapping:** >= 80 = 'good', >= 50 = 'needs-work', < 50 = 'poor'
         - **Checks calculation:** checksTotal = total steps across all workflows + pageAudits.length. checksPassed = passed steps + audits with no critical violations.
         - Guard against division by zero everywhere.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Verify the file exports `calculateHealthScore` and `HealthScore`.
  </verify>
  <done>
    health-scorer.ts exists, exports HealthScore interface and calculateHealthScore function. Handles edge cases (no workflows, no audits, division by zero). Veto logic caps score at 50 when any workflow fails.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create priority ranker</name>
  <files>src/reports/priority-ranker.ts</files>
  <action>
    Create `src/reports/priority-ranker.ts` with:

    - Import `DiagnosedError`, `UIAuditResult` from `../analysis/diagnosis-schema.js`
    - Import `ExecutionArtifact` from `../types/execution.js`

    - Export `IssuePriority` type: `'high' | 'medium' | 'low'`

    - Export `PrioritizedIssue` interface:
      ```typescript
      export interface PrioritizedIssue {
        priority: IssuePriority;
        category: string;         // e.g., "Workflow Error", "Console Error", "UI Issue", "Accessibility", "Dead Button", "Broken Form"
        summary: string;          // Plain English summary
        impact: string;           // Why it matters (plain English)
        fixSuggestion: string;    // How to fix (plain English)
        location: string;         // URL or file:line
        screenshotRef?: string;   // Path to screenshot if available
        technicalDetails?: string; // For AI report only
      }
      ```

    - Export `prioritizeIssues(diagnosedErrors: DiagnosedError[], uiAudits: UIAuditResult[], executionArtifact: ExecutionArtifact): PrioritizedIssue[]` function:

      **HIGH priority (workflow-blocking):**
      - DiagnosedErrors with errorType: 'navigation', 'authentication', 'form'
      - Impact: "This breaks a core user flow on your site"

      **MEDIUM priority:**
      - DiagnosedErrors with errorType: 'network', 'javascript'
      - Dead buttons (from executionArtifact.deadButtons where isDead === true)
      - Broken forms (from executionArtifact.brokenForms where isBroken === true)
      - UI audit layout/contrast issues with severity 'high'
      - Accessibility violations with impact 'critical' or 'serious' (from executionArtifact.pageAudits)
      - Impact: "This causes errors or confuses users"

      **LOW priority:**
      - DiagnosedErrors with errorType: 'dom', 'unknown'
      - UI audit issues with severity 'medium' or 'low'
      - UI audit formatting issues and improvements
      - Accessibility violations with impact 'moderate' or 'minor'
      - Impact: "This is a minor issue but worth fixing"

      Sort output: high first, then medium, then low. Within each priority, maintain insertion order.

      For dead buttons, generate plain English summary: "A button labeled '{selector}' doesn't do anything when clicked"
      For broken forms, generate: "A form on your site doesn't work when submitted"
      For accessibility violations, generate: "{description}" with fix: "Check accessibility guidelines at {helpUrl}"
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Confirm the file exports `prioritizeIssues`, `PrioritizedIssue`, and `IssuePriority`.
  </verify>
  <done>
    priority-ranker.ts exists, exports PrioritizedIssue interface and prioritizeIssues function. Issues are categorized as high/medium/low based on error type and severity. All summaries are plain English with no jargon. Output is sorted by priority (high first).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Both files exist in `src/reports/`
3. Handlebars and marked are in package.json dependencies
4. Health score veto logic is present (cap at 50 for failed workflows)
5. Priority ranker covers all issue types: diagnosed errors, dead buttons, broken forms, accessibility, UI audits
</verification>

<success_criteria>
- Health scorer produces 0-100 score with weighted average (40/30/20/10)
- Health scorer applies veto cap at 50 when workflows fail
- Health scorer labels: good >= 80, needs-work >= 50, poor < 50
- Priority ranker categorizes all issue types into high/medium/low
- Priority ranker outputs plain English summaries (zero jargon)
- Both modules compile cleanly with TypeScript strict mode
- Handlebars and marked installed in package.json
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-output/05-01-SUMMARY.md`
</output>
