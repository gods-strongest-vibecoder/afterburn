---
phase: 01-foundation-core-automation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/browser/stealth-browser.ts
  - src/browser/cookie-dismisser.ts
  - src/browser/browser-manager.ts
  - src/browser/index.ts
autonomous: true

must_haves:
  truths:
    - "Browser launches without triggering bot detection on real websites"
    - "Cookie consent banners are automatically dismissed before screenshots"
    - "Browser lifecycle is managed cleanly (launch, create context, close)"
  artifacts:
    - path: "src/browser/stealth-browser.ts"
      provides: "Stealth-enabled Playwright browser creation"
      exports: ["createStealthBrowser"]
      contains: "StealthPlugin"
    - path: "src/browser/cookie-dismisser.ts"
      provides: "Auto-detection and dismissal of cookie consent banners"
      exports: ["dismissCookieBanner", "COOKIE_SELECTORS"]
      contains: "onetrust"
    - path: "src/browser/browser-manager.ts"
      provides: "Browser lifecycle management (launch, context, page, close)"
      exports: ["BrowserManager"]
    - path: "src/browser/index.ts"
      provides: "Barrel export for browser module"
  key_links:
    - from: "src/browser/stealth-browser.ts"
      to: "playwright-extra"
      via: "chromium import with stealth plugin"
      pattern: "import.*playwright-extra"
    - from: "src/browser/stealth-browser.ts"
      to: "playwright-extra-plugin-stealth"
      via: "StealthPlugin applied to chromium"
      pattern: "chromium\\.use\\(StealthPlugin"
    - from: "src/browser/browser-manager.ts"
      to: "src/browser/stealth-browser.ts"
      via: "uses createStealthBrowser for launch"
      pattern: "createStealthBrowser"
    - from: "src/browser/browser-manager.ts"
      to: "src/browser/cookie-dismisser.ts"
      via: "calls dismissCookieBanner after navigation"
      pattern: "dismissCookieBanner"
---

<objective>
Implement stealth browser automation that bypasses anti-bot detection on real websites (Vercel, Netlify deployments) and automatically dismisses cookie consent banners before any page interaction.

Purpose: This is the #1 critical requirement -- without stealth mode, the tool fails on 60%+ of real websites. Cookie dismissal prevents banners from blocking screenshots and interactions. This is the foundation all subsequent phases depend on.
Output: Browser module that launches stealth Chromium, manages lifecycle, and auto-dismisses cookie banners.
</objective>

<execution_context>
@C:\Users\Shiv_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shiv_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-automation/01-RESEARCH.md
@src/types/artifacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stealth browser launcher with anti-bot evasion</name>
  <files>
    src/browser/stealth-browser.ts
  </files>
  <action>
    Create src/browser/stealth-browser.ts that wraps playwright-extra with the stealth plugin.

    Export `createStealthBrowser(config?: Partial<BrowserConfig>)` that:

    1. Imports `chromium` from `playwright-extra` and `StealthPlugin` from `playwright-extra-plugin-stealth`
    2. Applies StealthPlugin to chromium: `chromium.use(StealthPlugin())`
       - IMPORTANT: Only call `chromium.use()` ONCE. Guard with a module-level `let pluginApplied = false` flag to prevent duplicate plugin registration if called multiple times.
    3. Launches browser with stealth args:
       ```
       args: [
         '--disable-blink-features=AutomationControlled',
         '--disable-features=IsolateOrigins,site-per-process',
         '--disable-site-isolation-trials'
       ]
       ```
    4. Creates a browser context with realistic fingerprint:
       - userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
       - viewport: { width: 1920, height: 1080 }
       - locale: 'en-US'
       - timezoneId: 'America/New_York'
    5. Returns `{ browser, context }` object

    Use BrowserConfig type from src/types/artifacts.ts for config parameter.

    Do NOT use native Playwright `chromium` -- must use playwright-extra's chromium (the whole point is stealth).
    Do NOT hardcode config values -- use defaults that can be overridden via the config parameter.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports createStealthBrowser function
    - File imports from playwright-extra (not playwright)
    - StealthPlugin is applied before launch
  </verify>
  <done>
    createStealthBrowser() launches a Playwright browser with 17-module stealth evasion applied, realistic user fingerprint, and configurable options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cookie banner auto-dismissal and browser lifecycle manager</name>
  <files>
    src/browser/cookie-dismisser.ts
    src/browser/browser-manager.ts
    src/browser/index.ts
  </files>
  <action>
    **cookie-dismisser.ts:**

    1. Import CookieBannerSelector type from src/types/artifacts.ts
    2. Define and export `COOKIE_SELECTORS` array with these platforms (from RESEARCH.md):
       - OneTrust: acceptButton '#onetrust-accept-btn-handler', modal '#onetrust-banner-sdk'
       - Cookiebot: acceptButton '#CybotCookiebotDialogBodyLevelButtonLevelOptinAllowAll', modal '#CybotCookiebotDialog'
       - CookieYes: acceptButton '.cky-btn-accept', modal '.cky-consent-container'
       - Generic patterns: acceptButton 'button:has-text("Accept all"), button:has-text("Accept cookies"), button:has-text("Allow all"), button:has-text("I agree"), [id*="accept"], [class*="accept"]'
    3. Export `dismissCookieBanner(page: Page): Promise<{ dismissed: boolean; platform: string | null }>` that:
       - Iterates selectors with 2-second visibility timeout per selector
       - Clicks the first visible accept button
       - If modal selector exists, waits for it to become hidden (5-second timeout)
       - Waits 500ms after dismissal for animations
       - Returns which platform was dismissed (or null if no banner found)
       - Catches all errors per selector and continues to next (never throws)

    **browser-manager.ts:**

    Create `BrowserManager` class that orchestrates browser lifecycle:

    1. Constructor takes optional BrowserConfig
    2. `async launch()`: Calls createStealthBrowser(), stores browser + context references
    3. `async newPage(url?: string)`: Creates new page from context. If URL provided, navigates to it with `waitUntil: 'domcontentloaded'` then calls `dismissCookieBanner(page)`, then waits for `networkidle` (5-second timeout, catch timeout errors gracefully -- some sites never reach networkidle)
    4. `async close()`: Closes browser, nulls references. Safe to call multiple times.
    5. Has `get isLaunched(): boolean` getter

    Do NOT use `page.waitForLoadState('networkidle')` without a timeout -- some SPAs never reach networkidle.
    Do NOT swallow errors in launch/close -- only swallow in cookie dismissal.

    **index.ts:**

    Barrel export: export everything from stealth-browser.js, cookie-dismisser.js, browser-manager.js
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - COOKIE_SELECTORS has at least 4 entries (OneTrust, Cookiebot, CookieYes, Generic)
    - BrowserManager has launch(), newPage(), close() methods
    - dismissCookieBanner never throws (always returns result object)
  </verify>
  <done>
    Cookie dismisser handles 4 major cookie consent platforms with graceful fallbacks. BrowserManager provides clean lifecycle management with auto-cookie-dismissal on navigation. Both compile and integrate with stealth-browser.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for entire project
- src/browser/ contains 4 files: stealth-browser.ts, cookie-dismisser.ts, browser-manager.ts, index.ts
- stealth-browser.ts imports from playwright-extra (not playwright)
- cookie-dismisser.ts has at least 4 cookie platform selectors
- browser-manager.ts uses both stealth-browser and cookie-dismisser
</verification>

<success_criteria>
- Stealth browser creation wraps playwright-extra with stealth plugin and realistic fingerprint
- Cookie dismissal covers OneTrust, Cookiebot, CookieYes, and generic patterns
- BrowserManager provides clean launch/navigate/close lifecycle
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-automation/01-02-SUMMARY.md`
</output>
