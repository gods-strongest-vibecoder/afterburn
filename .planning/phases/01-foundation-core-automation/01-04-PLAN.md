---
phase: 01-foundation-core-automation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/cli/progress.ts
  - src/cli/first-run.ts
  - src/cli/index.ts
  - src/index.ts
autonomous: false

must_haves:
  truths:
    - "First-run browser download shows spinner with size estimate"
    - "Subsequent runs skip download and show 'Browser ready' immediately"
    - "Running the tool against a URL launches stealth browser, dismisses cookies, captures screenshots, and saves artifacts"
    - "All modules integrate: browser -> screenshots -> artifacts -> CLI progress"
  artifacts:
    - path: "src/cli/first-run.ts"
      provides: "Browser installation check and progress indicator"
      exports: ["ensureBrowserInstalled"]
      contains: "ora"
    - path: "src/cli/progress.ts"
      provides: "Reusable progress spinners for pipeline stages"
      exports: ["createSpinner", "withSpinner"]
    - path: "src/cli/index.ts"
      provides: "Barrel export for CLI module"
    - path: "src/index.ts"
      provides: "Main entry point wiring all modules together"
      contains: "BrowserManager"
  key_links:
    - from: "src/cli/first-run.ts"
      to: "ora"
      via: "spinner during browser download"
      pattern: "ora\\("
    - from: "src/cli/first-run.ts"
      to: "playwright"
      via: "checks for browser binary existence"
      pattern: "ms-playwright|chromium"
    - from: "src/index.ts"
      to: "src/browser/browser-manager.ts"
      via: "creates BrowserManager for browser lifecycle"
      pattern: "BrowserManager"
    - from: "src/index.ts"
      to: "src/screenshots/screenshot-manager.ts"
      via: "creates ScreenshotManager for captures"
      pattern: "ScreenshotManager"
    - from: "src/index.ts"
      to: "src/artifacts/artifact-storage.ts"
      via: "creates ArtifactStorage for persistence"
      pattern: "ArtifactStorage"
    - from: "src/index.ts"
      to: "src/cli/first-run.ts"
      via: "calls ensureBrowserInstalled before launch"
      pattern: "ensureBrowserInstalled"
---

<objective>
Create CLI progress indicators for first-run browser download and wire all Phase 1 modules together into a working entry point that can launch a stealth browser, navigate to a URL, dismiss cookies, capture screenshots, and save artifacts.

Purpose: This plan integrates everything from Plans 01-03 into a single working pipeline. Without this wiring, the individual modules are isolated and untestable end-to-end. The first-run progress indicator prevents user abandonment during the 150-280MB browser download.
Output: Working `src/index.ts` that demonstrates the complete Phase 1 pipeline, plus first-run download UX.
</objective>

<execution_context>
@C:\Users\Shiv_\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shiv_\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-automation/01-RESEARCH.md
@src/types/artifacts.ts
@src/browser/index.ts
@src/screenshots/index.ts
@src/artifacts/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create first-run browser check and CLI progress utilities</name>
  <files>
    src/cli/first-run.ts
    src/cli/progress.ts
    src/cli/index.ts
  </files>
  <action>
    **first-run.ts:**

    Export `ensureBrowserInstalled(): Promise<void>` that:
    1. Creates an ora spinner: "Checking browser installation..."
    2. Checks if Chromium binary exists by looking for the playwright cache directory:
       - Use `path.join(os.homedir(), '.cache', 'ms-playwright')` on Linux/Mac
       - Use `path.join(process.env.LOCALAPPDATA || os.homedir(), 'ms-playwright')` on Windows
       - Check with `fs.existsSync()` and also check for chromium subdirectories using `fs.readdirSync().filter(d => d.startsWith('chromium-'))`
    3. If browser found: spinner.succeed('Browser ready')
    4. If NOT found:
       - Update spinner text: 'First run: Downloading Chromium (150-280MB)... this may take a minute'
       - Run `npx playwright install chromium` via child_process.execSync with `{ stdio: 'pipe' }` to suppress Playwright's own output
       - On success: spinner.succeed('Browser installed successfully')
       - On failure: spinner.fail('Browser installation failed'), then throw error with helpful message: "Failed to install Chromium. Run manually: npx playwright install chromium"

    Import `os` from 'node:os', `path` from 'node:path', `fs` from 'node:fs', `execSync` from 'node:child_process'.

    **progress.ts:**

    Export reusable progress utilities for the pipeline:
    1. `createSpinner(text: string): ora.Ora` -- creates an ora spinner with cyan color and dots style
    2. `withSpinner<T>(text: string, fn: () => Promise<T>): Promise<T>` -- wraps an async function with a spinner that auto-succeeds or fails:
       - Starts spinner with text
       - Runs fn()
       - On success: spinner.succeed(text + ' done'), returns result
       - On failure: spinner.fail(text + ' failed'), re-throws error

    **index.ts:**

    Barrel export from first-run.js and progress.js.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - first-run.ts handles both Windows and Unix paths for playwright cache
    - progress.ts exports createSpinner and withSpinner
    - No hardcoded Unix-only paths (check for '/' without path.join)
  </verify>
  <done>
    First-run check detects browser installation cross-platform and shows ora spinner during download. withSpinner utility wraps any async operation with progress feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire all modules into main entry point with end-to-end smoke test</name>
  <files>
    src/index.ts
  </files>
  <action>
    Create src/index.ts as the main entry point that demonstrates the full Phase 1 pipeline:

    1. Add shebang line: `#!/usr/bin/env node`
    2. Import all modules:
       - `{ BrowserManager }` from './browser/index.js'
       - `{ ScreenshotManager }` from './screenshots/index.js'
       - `{ ArtifactStorage }` from './artifacts/index.js'
       - `{ ensureBrowserInstalled, withSpinner }` from './cli/index.js'
       - `crypto` from 'node:crypto'
    3. Create `main()` async function that:
       a. Prints "Afterburn v0.1.0 - Automated Web Testing\n"
       b. Calls `ensureBrowserInstalled()` (first-run check)
       c. Gets target URL from `process.argv[2]` -- if not provided, print usage and exit(1):
          "Usage: afterburn <url>\nExample: afterburn https://example.com"
       d. Generates sessionId via `crypto.randomUUID()`
       e. Creates instances: BrowserManager, ScreenshotManager, ArtifactStorage
       f. Wraps browser launch in withSpinner('Launching browser')
       g. Wraps navigation in withSpinner('Navigating to {url}'):
          - browserManager.newPage(url) -- this auto-dismisses cookies
       h. Wraps screenshot capture in withSpinner('Capturing screenshots'):
          - screenshotManager.capture(page, 'initial')
       i. Saves a basic session artifact:
          ```
          { version: "1.0", stage: "session", timestamp: new Date().toISOString(), sessionId, targetUrl: url, screenshots: [screenshotRef] }
          ```
       j. Prints summary: screenshot paths, sizes, reduction percentage
       k. Closes browser via browserManager.close()
       l. Wraps everything in try/catch -- on error, print error message and ensure browser is closed

    4. Call `main()` at bottom of file

    This is a MINIMAL integration -- just enough to prove all modules work together. It is NOT the final CLI (Commander.js integration comes in Phase 6). The purpose is to validate the pipeline end-to-end.

    Do NOT add Commander.js argument parsing yet -- just process.argv[2] for now.
    Do NOT add complex error handling or retry logic -- keep it simple for Phase 1.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx tsc` builds to dist/ without errors
    - src/index.ts imports from all four modules (browser, screenshots, artifacts, cli)
    - Run `npx tsx src/index.ts https://example.com` and verify:
      1. Browser check spinner appears
      2. Browser launches (or downloads on first run)
      3. Page navigates
      4. Screenshot files appear in .afterburn/screenshots/ (both .png and .webp)
      5. Artifact JSON appears in .afterburn/artifacts/
      6. Browser closes cleanly
      7. Exit code 0
  </verify>
  <done>
    Running `npx tsx src/index.ts https://example.com` produces dual-format screenshots in .afterburn/screenshots/ and a session artifact in .afterburn/artifacts/. Browser launches with stealth, cookies are dismissed, and progress spinners show throughout.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 pipeline: stealth browser launch, cookie dismissal, dual-format screenshots, artifact storage, and first-run progress indicators -- all wired together in src/index.ts.
  </what-built>
  <how-to-verify>
    1. Run: `npx tsx src/index.ts https://example.com`
       - Expected: Progress spinners for browser check, launch, navigation, screenshot capture
       - Expected: Output shows screenshot file paths and size reduction percentage
    2. Check .afterburn/screenshots/ directory:
       - Expected: At least one .png file and one .webp file
       - Expected: WebP is smaller than PNG (check file sizes)
    3. Check .afterburn/artifacts/ directory:
       - Expected: A session-*.json file with version, stage, timestamp, sessionId, screenshots
    4. Run: `npx tsx src/index.ts` (no URL)
       - Expected: Usage message and exit code 1
    5. (Optional) Run against a real Vercel/Netlify site to test stealth:
       `npx tsx src/index.ts https://vercel.com`
       - Expected: Page loads without 403/429 errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc` builds successfully to dist/
- `npx tsx src/index.ts https://example.com` runs end-to-end without errors
- .afterburn/screenshots/ contains .png and .webp files
- .afterburn/artifacts/ contains session JSON file
- First-run shows download progress (or skip if already installed)
- No URL argument shows usage message
</verification>

<success_criteria>
- All Phase 1 modules integrate: browser -> screenshots -> artifacts -> CLI
- First-run browser download shows progress spinner with size estimate
- End-to-end pipeline works: stealth launch, navigate, dismiss cookies, capture dual-format screenshots, save artifact
- All 5 Phase 1 success criteria from ROADMAP are demonstrable
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-automation/01-04-SUMMARY.md`
</output>
